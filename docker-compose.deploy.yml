version: '3.8'

services:

  nginx:
    image: nginx:1.21.6
    container_name: graffiti-nginx
    volumes:
      - ./config/nginx.conf:/etc/nginx/nginx.conf:ro
      - /etc/letsencrypt/live/graffiti.csail.mit.edu/fullchain.pem:/etc/ssl/certs/fullchain.pem:ro
      - /etc/letsencrypt/live/graffiti.csail.mit.edu/privkey.pem:/etc/ssl/certs/privkey.pem:ro
    ports:
      - 80:80
      - 443:443
    depends_on:
      - graffiti

  mailserver:
    image: mailserver/docker-mailserver:10.4.0
    container_name: graffiti-mailserver
    hostname: graffiti.csail.mit.edu
    domainname: graffiti.csail.mit.edu
    volumes:
      - ./config/mailserver:/tmp/docker-mailserver/
      - /etc/letsencrypt/live/graffiti.csail.mit.edu/fullchain.pem:/etc/ssl/certs/fullchain.pem:ro
      - /etc/letsencrypt/live/graffiti.csail.mit.edu/privkey.pem:/etc/ssl/certs/privkey.pem:ro
      - /etc/localtime:/etc/localtime:ro
    expose:
      - 25
    env_file: config/mailserver.env
    cap_add:
      - NET_ADMIN
      - SYS_PTRACE
    restart: always

  graffiti:
    environment:
      DEBUG: 'false'
      AUTH_CODE_MAIL_FROM: 'Graffiti <noreply@graffiti.csail.mit.edu>'
    expose:
      - 5000
    depends_on:
      - mailserver
